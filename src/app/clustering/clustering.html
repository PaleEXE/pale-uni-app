<div class="flex flex-col justify-center items-center h-full">
  <div class="flex justify-center items-center h-6 mb-8 mt-6">
    <h1 class="text-3xl font-bold text-primary-700">Clustering</h1>
  </div>

  <div class="flex gap-4 items-start">
    <div
      class="flex flex-col gap-6 w-72 p-6 bg-primary-100 border border-primary-300 rounded-lg shadow shrink-0"
    >
      <div>
        <h3 class="text-sm font-semibold mb-2 text-primary-700">Interaction</h3>
        <div class="flex bg-primary-200 p-1 rounded-md mb-2">
          <button
            class="flex-1 text-xs font-bold py-1.5 rounded transition-colors"
            [class.bg-white]="interactionMode() === 'draw'"
            [class.text-primary-700]="interactionMode() === 'draw'"
            [class.text-primary-500]="interactionMode() !== 'draw'"
            (click)="interactionMode.set('draw')"
          >
            DRAW
          </button>
          <button
            class="flex-1 text-xs font-bold py-1.5 rounded transition-colors"
            [class.bg-white]="interactionMode() === 'pan'"
            [class.text-primary-700]="interactionMode() === 'pan'"
            [class.text-primary-500]="interactionMode() !== 'pan'"
            (click)="interactionMode.set('pan')"
          >
            PAN
          </button>
        </div>
        <button
          (click)="deleteMode.set(!deleteMode())"
          class="w-full text-xs font-bold py-1.5 rounded border transition-colors"
          [class.bg-red-100]="deleteMode()"
          [class.text-red-700]="deleteMode()"
          [class.border-red-300]="deleteMode()"
          [class.bg-white]="!deleteMode()"
          [class.text-gray-500]="!deleteMode()"
          [class.border-gray-200]="!deleteMode()"
        >
          {{ deleteMode() ? 'DELETE MODE ACTIVE' : 'Enable Delete Mode' }}
        </button>
      </div>

      <div>
        <h3 class="text-sm font-semibold mb-2 text-primary-700">Algorithm</h3>
        <select
          class="w-full px-3 py-2 bg-primary-500 text-white rounded-md cursor-pointer text-sm font-bold mb-4 focus:outline-none focus:ring-2 focus:ring-primary-700"
          [value]="selectedAlgorithm()"
          (change)="selectedAlgorithm.set($any($event.target).value)"
        >
          <option value="kmeans">K-Means</option>
          <option value="Agglomerative">Agglomerative</option>
          <option value="DBSCAN">DBSCAN</option>
        </select>

        @if (selectedAlgorithm() !== 'DBSCAN') {
        <div class="mb-2">
          <div class="flex justify-between text-xs text-primary-700 mb-1">
            <span>Clusters (k)</span>
            <span class="font-bold">{{ clusterCount() }}</span>
          </div>
          <input
            type="range"
            min="1"
            max="10"
            step="1"
            [value]="clusterCount()"
            (input)="clusterCount.set($any($event.target).valueAsNumber)"
            class="slider"
          />
        </div>
        } @if (selectedAlgorithm() === 'DBSCAN') {
        <div class="space-y-3">
          <div>
            <div class="flex justify-between text-xs text-primary-700 mb-1">
              <span>Epsilon (eps)</span>
              <span class="font-bold">{{ eps() | number:'1.1-1' }}</span>
            </div>
            <input
              type="range"
              min="0.1"
              max="5.0"
              step="0.1"
              [value]="eps()"
              (input)="eps.set($any($event.target).valueAsNumber)"
              class="slider"
            />
          </div>
          <div>
            <div class="flex justify-between text-xs text-primary-700 mb-1">
              <span>Min Samples</span>
              <span class="font-bold">{{ minSamples() }}</span>
            </div>
            <input
              type="range"
              min="1"
              max="10"
              step="1"
              [value]="minSamples()"
              (input)="minSamples.set($any($event.target).valueAsNumber)"
              class="slider"
            />
          </div>
          <div class="flex items-center gap-2">
            <input
              type="checkbox"
              [checked]="showBorder()"
              (change)="showBorder.set(!showBorder())"
              class="accent-primary-600"
            />
            <label class="text-xs text-primary-700">Show eps radii</label>
          </div>
        </div>
        }
      </div>

      <button
        class="pale-button bg-primary-600 text-white hover:bg-primary-700 mt-2"
        (click)="performClustering()"
      >
        Run Clustering
      </button>

      <button class="pale-button mt-auto" (click)="reset()">
        Clear Points
      </button>
    </div>

    <div
      class="relative h-[600px] w-[600px] bg-primary-50 border-2 rounded-lg shadow overflow-hidden select-none"
      #plotArea
      [class.border-primary-500]="!deleteMode()"
      [class.border-red-500]="deleteMode()"
      [class.cursor-crosshair]="interactionMode() === 'draw' || deleteMode()"
      [class.cursor-move]="interactionMode() === 'pan'"
      (wheel)="onWheel($event)"
      (mousedown)="onPlotMouseDown($event)"
      (mousemove)="onPlotMouseMoveLocal($event)"
      (mouseleave)="onPlotLeave()"
      (contextmenu)="$event.preventDefault()"
    >
      <div
        class="absolute bg-primary-300 w-0.5 top-0 bottom-0"
        [style.left.px]="toScreenX(0)"
      ></div>
      <div
        class="absolute bg-primary-300 h-0.5 left-0 right-0"
        [style.top.px]="toScreenY(0)"
      ></div>

      <svg class="absolute inset-0 w-full h-full pointer-events-none z-10">
        @for (tick of xTicks(); track tick) {
        <g
          [attr.transform]="'translate(' + toScreenX(tick) + ',' + (height() - 15) + ')'"
        >
          <line y1="-5" y2="0" class="stroke-primary-400" stroke-width="2" />
          <text
            y="12"
            text-anchor="middle"
            class="text-[10px] fill-primary-600 font-bold font-mono"
          >
            {{ tick | number:'1.0-1' }}
          </text>
        </g>
        } @for (tick of yTicks(); track tick) {
        <g [attr.transform]="'translate(20,' + toScreenY(tick) + ')'">
          <line x1="-5" x2="0" class="stroke-primary-400" stroke-width="2" />
          <text
            x="-8"
            dy="4"
            text-anchor="end"
            class="text-[10px] fill-primary-600 font-bold font-mono"
          >
            {{ tick | number:'1.0-1' }}
          </text>
        </g>
        }
      </svg>

      @if (selectedAlgorithm() === 'DBSCAN' && showBorder()) { @for (point of
      points(); track $index) {
      <div
        class="absolute rounded-full opacity-1 pointer-events-none z-10"
        [class]="getPointColor($index)"
        [style.width.px]="pixelEps()"
        [style.height.px]="pixelEps()"
        [style.left.px]="toScreenX(point[0]) - pixelEps()/2"
        [style.top.px]="toScreenY(point[1]) - pixelEps()/2"
      ></div>
      } } @for (point of points(); track $index) {
      <div
        class="absolute rounded-full shadow-sm z-20 cursor-pointer hover:scale-125 transition-transform"
        [class]="getPointColor($index)"
        [style.width.px]="pointSize()"
        [style.height.px]="pointSize()"
        [style.left.px]="toScreenX(point[0]) - pointSize()/2"
        [style.top.px]="toScreenY(point[1]) - pointSize()/2"
      ></div>
      } @for (centroid of centroids(); track $index) {
      <div
        class="absolute rounded-full border-2 border-white shadow-md z-30 pointer-events-none"
        [class]="getCentroidColor($index)"
        [style.width.px]="pointSize() * 2"
        [style.height.px]="pointSize() * 2"
        [style.left.px]="toScreenX(centroid[0]) - pointSize()"
        [style.top.px]="toScreenY(centroid[1]) - pointSize()"
      ></div>
      } @if (cursorPosition(); as pos) {
      <div
        class="absolute bottom-2 right-2 px-2 py-1 bg-white/80 border border-primary-300 text-primary-900 text-xs font-mono font-bold rounded shadow-sm z-30 pointer-events-none"
      >
        {{ pos[0] | number:'1.1-1' }}, {{ pos[1] | number:'1.1-1' }}
      </div>
      }
    </div>
  </div>
</div>
