<div class="flex flex-col justify-center items-center h-full">
  <!-- Header -->
  <div class="flex justify-center items-center h-6 mb-8 mt-6">
    <h1 class="text-3xl font-bold text-primary-700">Graph Builder</h1>
  </div>

  <!-- Hidden File Input -->
  <input
    #fileInput
    type="file"
    accept="image/*"
    class="hidden"
    (change)="onFileSelected($event)"
  />

  <div class="flex flex-col">
    <div class="flex">
      <!-- ================= SIDEBAR ================= -->
      <div
        class="flex flex-col gap-6 m-6 w-64 p-6 bg-primary-100 border border-primary-300 rounded-lg shadow"
      >
        <!-- Info -->
        <div>
          <h2 class="text-lg font-semibold mb-4 text-primary-700">Info</h2>

          <div class="space-y-3">
            <div
              class="bg-white/80 p-3 border border-primary-300 rounded shadow-sm"
            >
              <p class="text-sm text-primary-600"><strong>Nodes:</strong></p>
              <p class="text-lg font-bold text-primary-700">
                {{ nodes().length }}
              </p>
            </div>

            <div
              class="bg-white/80 p-3 border border-primary-300 rounded shadow-sm"
            >
              <p class="text-sm text-primary-600"><strong>Edges:</strong></p>
              <p class="text-lg font-bold text-primary-700">
                {{ edges().length }}
              </p>
            </div>

            <!-- Node Size -->
            <div
              class="bg-white/80 p-3 border border-primary-300 rounded shadow-sm"
            >
              <p class="text-sm text-primary-600">
                <strong>Node Size:</strong>
              </p>

              <div class="flex items-center gap-2 mt-2">
                <input
                  type="range"
                  min="16"
                  max="64"
                  step="1"
                  class="slider flex-1"
                  [value]="nodeSize()"
                  (input)="nodeSize.set($any($event.target).valueAsNumber)"
                />

                <span
                  class="h-6 w-8 flex items-center justify-center text-xs bg-white border border-primary-300 rounded text-primary-700 font-semibold shadow-sm"
                >
                  {{ nodeSize() }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Upload Section -->
        <div class="space-y-2">
          <button
            class="pale-button h-12 w-full bg-green-600 text-white hover:bg-green-700"
            (click)="triggerFileUpload()"
            [disabled]="uploading()"
          >
            {{ uploading() ? 'Uploading...' : 'Upload Graph Image' }}
          </button>

          @if (uploadSuccess()) {
          <div
            class="p-2 bg-green-100 border border-green-400 rounded text-xs text-green-800"
          >
            {{ uploadSuccess() }}
          </div>
          } @if (uploadError()) {
          <div
            class="p-2 bg-red-100 border border-red-400 rounded text-xs text-red-800"
          >
            {{ uploadError() }}
          </div>
          }
        </div>

        <!-- Modes -->
        <div class="space-y-2">
          <button
            class="pale-button h-12 w-full"
            [class.bg-blue-600]="linkMode()"
            (click)="toggleLinkMode()"
          >
            {{ linkMode() ? 'Cancel Link' : 'Link Nodes' }}
          </button>

          <button
            class="pale-button h-12 w-full"
            [class.bg-red-600]="deleteMode()"
            (click)="toggleDeleteMode()"
          >
            {{ deleteMode() ? 'Cancel Delete' : 'Delete Nodes' }}
          </button>
        </div>

        <!-- Info -->
        @if (linkMode() && selectedNodeId() !== null) {
        <div
          class="bg-primary-100 p-3 rounded border border-primary-300 text-sm text-primary-700"
        >
          <p>
            Selected Node:
            <strong>{{ selectedNodeId() }}</strong>
          </p>
          <p class="text-xs mt-1">Click another node to connect it</p>
        </div>
        }

        <!-- Actions -->
        <div class="space-y-2">
          <button
            class="pale-button h-12 bg-primary-500 text-white hover:bg-primary-600"
            (click)="reset()"
          >
            Reset
          </button>

          <!-- Save Graph Section -->
          <div class="border-t-2 border-primary-300 pt-3">
            <h3 class="text-sm font-semibold text-primary-700 mb-2">
              Save Graph
            </h3>

            <input
              type="text"
              placeholder="Graph name..."
              [(ngModel)]="visualName"
              (keyup.enter)="saveCurrentGraph()"
              class="w-full px-3 py-2 border border-primary-300 rounded text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
            />

            <button
              class="pale-button h-10 w-full text-sm bg-green-600 text-white hover:bg-green-700"
              (click)="saveCurrentGraph()"
              [disabled]="savingVisual() || nodes().length === 0"
            >
              {{ savingVisual() ? 'Saving...' : 'Save Graph' }}
            </button>

            @if (saveSuccess()) {
            <div
              class="mt-2 p-2 bg-green-100 border border-green-400 rounded text-xs text-green-800"
            >
              {{ saveSuccess() }}
            </div>
            } @if (saveError()) {
            <div
              class="mt-2 p-2 bg-red-100 border border-red-400 rounded text-xs text-red-800"
            >
              {{ saveError() }}
            </div>
            }
          </div>

          <!-- Load Graph Section -->
          <button
            class="pale-button h-10 w-full text-sm bg-blue-600 text-white hover:bg-blue-700"
            (click)="toggleSavedVisuals()"
          >
            {{ showSavedVisuals() ? 'Hide Saved' : 'Load Graph' }}
          </button>

          <button
            class="pale-button h-12 bg-primary-500 text-white hover:bg-primary-600"
            (click)="back()"
          >
            Back
          </button>
        </div>
      </div>

      <!-- ================= MAIN VIEW ================= -->
      <div class="flex flex-row gap-6 mt-6 mr-6 items-start">
        <!-- ============ PLOT AREA ============ -->

        <div
          #plotArea
          class="relative w-[560px] h-[560px] border-2 bg-primary-50 rounded-lg shadow select-none overflow-hidden"
          [class.border-primary-500]="!deleteMode() && !linkMode()"
          [class.border-red-500]="deleteMode()"
          [class.border-blue-500]="linkMode()"
          [class.cursor-crosshair]="deleteMode() || linkMode()"
          [class.cursor-default]="!deleteMode() && !linkMode()"
          (click)="onPlotClick($event)"
          (mousemove)="onPlotMouseMove($event)"
          (mouseup)="onPlotMouseUp()"
          (mouseleave)="onPlotMouseUp()"
        >
          <!-- Axes -->
          <div
            class="absolute left-1/2 top-0 bottom-0 w-[2px] bg-primary-300 -translate-x-1/2 pointer-events-none"
          ></div>

          <div
            class="absolute top-1/2 left-0 right-0 h-[2px] bg-primary-300 -translate-y-1/2 pointer-events-none"
          ></div>

          <!-- Edges -->
          <svg class="absolute inset-0 w-full h-full pointer-events-none">
            @for (edge of edges(); track $index) {
            <path
              [attr.d]="getEdgePath(getNodeById(edge[0]), getNodeById(edge[1]))"
              stroke="#a855f7"
              stroke-width="2"
              fill="none"
            />
            }
          </svg>

          <!-- Nodes -->
          @for (node of nodes(); track node.id) {

          <div
            class="absolute rounded-full border-2 shadow-md hover:shadow-lg transition-shadow cursor-grab active:cursor-grabbing z-10 flex items-center justify-center"
            [style.left.px]="getPosX(node.pos)"
            [style.top.px]="getPosY(node.pos)"
            [style.width.px]="nodeSize()"
            [style.height.px]="nodeSize()"
            [class.bg-primary-500]="!isNodeSelected(node.id)"
            [class.bg-blue-500]="isNodeSelected(node.id)"
            [class.border-primary-700]="!isNodeSelected(node.id)"
            [class.border-blue-700]="isNodeSelected(node.id)"
            (mousedown)="onNodeMouseDown($event, node.id)"
            (dblclick)="startEditingLabel(node.id)"
            [title]="'Node ' + node.id + ' (' + node.label + ')'"
          >
            @if (editingNodeId() !== node.id) {
            <span class="text-white font-bold text-center">
              {{ node.label }}
            </span>
            }
          </div>

          }

          <!-- Label Edit Modal -->
          @if (editingNodeId() !== null) {
          <div
            class="absolute inset-0 flex items-center justify-center bg-black/50 z-50"
            (click)="cancelEditingLabel()"
          >
            <div
              class="bg-white p-6 rounded-lg shadow-lg border-2 border-primary-500"
              (click)="$event.stopPropagation()"
            >
              <h3 class="text-lg font-bold text-primary-700 mb-4">
                Edit Node Label
              </h3>

              <input
                type="text"
                [value]="editingLabel()"
                (input)="editingLabel.set($any($event.target).value.toUpperCase())"
                (keyup.enter)="saveLabel()"
                (keyup.escape)="cancelEditingLabel()"
                class="w-32 px-3 py-2 border-2 border-primary-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 text-center font-bold text-lg"
                placeholder="A"
                autofocus
              />

              <div class="flex gap-2 mt-4">
                <button
                  class="px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600"
                  (click)="saveLabel()"
                >
                  Save
                </button>
                <button
                  class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400"
                  (click)="cancelEditingLabel()"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
          }

          <!-- Saved Graphs Modal -->
          @if (showSavedVisuals()) {
          <div
            class="absolute inset-0 flex items-center justify-center bg-black/50 z-50"
            (click)="showSavedVisuals.set(false)"
          >
            <div
              class="bg-white p-6 rounded-lg shadow-lg border-2 border-primary-500 w-96 max-h-96 overflow-y-auto"
              (click)="$event.stopPropagation()"
            >
              <h3 class="text-lg font-bold text-primary-700 mb-4">
                Saved Graphs
              </h3>

              @if (loadingVisuals()) {
              <div class="text-center text-primary-600">Loading...</div>
              } @else if (savedVisuals().length === 0) {
              <div class="text-center text-gray-600">No saved graphs yet</div>
              } @else {
              <div class="space-y-2">
                @for (visual of savedVisuals(); track visual.id) {
                <div
                  class="flex items-center justify-between p-3 bg-primary-50 border border-primary-300 rounded hover:bg-primary-100"
                >
                  <div class="flex-1">
                    <p class="font-semibold text-primary-700">
                      {{ visual.type }}
                    </p>
                    <p class="text-xs text-primary-600">
                      Nodes: {{ visual.saved_visual['nodes'].length }}, Edges:
                      {{ visual.saved_visual['edges'].length }}
                    </p>
                  </div>

                  <div class="flex gap-2">
                    <button
                      class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
                      (click)="loadGraphFromSaved(visual)"
                    >
                      Load
                    </button>

                    <button
                      class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600"
                      (click)="deleteGraphFromSaved(visual.id, visual.type)"
                    >
                      Delete
                    </button>
                  </div>
                </div>
                }
              </div>
              }

              <button
                class="w-full mt-4 px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500"
                (click)="showSavedVisuals.set(false)"
              >
                Close
              </button>
            </div>
          </div>
          }
        </div>

        <!-- ================= RIGHT PANEL ================= -->

        <div class="w-64 space-y-4">
          <!-- TRAVERSAL CONTROLS -->
          <div
            class="p-4 bg-primary-100 border border-primary-300 rounded-lg shadow"
          >
            <h3 class="font-semibold text-primary-700 mb-3">Traversal</h3>

            @if (nodes().length > 0) {

            <label class="text-sm text-primary-700 block mb-2">
              Start Node:
            </label>

            <select
              class="w-full px-2 py-2 border border-primary-300 rounded bg-white text-primary-700 text-sm mb-3"
              [(ngModel)]="startNodeModel"
              (change)="onStartNodeChange(startNodeModel)"
            >
              @for (node of nodes(); track node.id) {
              <option [ngValue]="node.id">
                Node {{ node.id }} ({{ node.label }})
              </option>
              }
            </select>

            }

            <div class="space-y-2">
              <button
                class="pale-button h-10 w-full text-sm bg-primary-500 text-white hover:bg-primary-600"
                (click)="performDFS()"
                [disabled]="nodes().length === 0"
              >
                Run DFS
              </button>

              <button
                class="pale-button h-10 w-full text-sm bg-primary-500 text-white hover:bg-primary-600"
                (click)="performBFS()"
                [disabled]="nodes().length === 0"
              >
                Run BFS
              </button>
            </div>
          </div>

          <!-- RESULTS -->
          @if (dfsResult().length > 0 || bfsResult().length > 0) {

          <div
            class="p-4 bg-primary-100 border-2 border-primary-400 rounded-lg shadow"
          >
            <h3 class="font-bold text-primary-700 mb-3">
              {{ dfsResult().length > 0 ? 'DFS Traversal' : 'BFS Traversal' }}
              Result
            </h3>

            <div class="flex flex-wrap gap-2">
              @for (nodeId of (dfsResult().length > 0 ? dfsResult() :
              bfsResult()); track $index) {

              <div
                class="px-3 py-1 bg-primary-500 text-white rounded-full font-semibold text-sm shadow"
              >
                {{ getNodeById(nodeId)?.label }}
              </div>

              }
            </div>

            <p class="text-sm text-primary-700 mt-3">
              {{ algorithmMessage() }}
            </p>
          </div>

          } @else if (algorithmMessage()) {

          <div
            class="p-4 bg-primary-100 border-2 border-primary-400 rounded-lg shadow"
          >
            <p class="text-primary-700 font-semibold">
              {{ algorithmMessage() }}
            </p>
          </div>

          }
        </div>
      </div>
    </div>
  </div>
</div>
